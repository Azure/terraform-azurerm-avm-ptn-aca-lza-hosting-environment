<!-- BEGIN_TF_DOCS -->
<!-- Code generated by terraform-docs. DO NOT EDIT. -->
# Complex Network Appliance

This example demonstrates the most sophisticated enterprise-grade deployment with Azure Firewall as a network virtual appliance, custom routing, and maximum feature enablement.

```hcl
terraform {
  required_version = ">= 1.9, < 2.0"

  required_providers {
    azapi = {
      source  = "Azure/azapi"
      version = "~> 2.4"
    }
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "~> 4.0"
    }
    tls = {
      source  = "hashicorp/tls"
      version = "~> 4.0"
    }
  }
}

provider "azurerm" {
  features {}
  storage_use_azuread = true
}

# Generate SSH key for Linux VM
resource "tls_private_key" "ssh_key" {
  algorithm = "RSA"
  rsa_bits  = 4096
}

# Create complex hub network with multiple appliances
resource "azurerm_resource_group" "hub" {
  location = var.location
  name     = "${var.resource_group_name}-hub-complex"
}

resource "azurerm_virtual_network" "hub" {
  location            = azurerm_resource_group.hub.location
  name                = "vnet-hub-complex"
  resource_group_name = azurerm_resource_group.hub.name
  address_space       = ["10.100.0.0/16"]
  tags                = var.tags
}

# Azure Firewall subnet
resource "azurerm_subnet" "firewall" {
  address_prefixes     = ["10.100.1.0/24"]
  name                 = "AzureFirewallSubnet"
  resource_group_name  = azurerm_resource_group.hub.name
  virtual_network_name = azurerm_virtual_network.hub.name
}

# Management subnet for firewall
resource "azurerm_subnet" "firewall_mgmt" {
  address_prefixes     = ["10.100.2.0/24"]
  name                 = "AzureFirewallManagementSubnet"
  resource_group_name  = azurerm_resource_group.hub.name
  virtual_network_name = azurerm_virtual_network.hub.name
}

# Public IPs for Azure Firewall
resource "azurerm_public_ip" "firewall" {
  allocation_method   = "Static"
  location            = azurerm_resource_group.hub.location
  name                = "pip-fw-complex"
  resource_group_name = azurerm_resource_group.hub.name
  sku                 = "Standard"
  tags                = var.tags
  zones               = ["1", "2", "3"]
}

resource "azurerm_public_ip" "firewall_mgmt" {
  allocation_method   = "Static"
  location            = azurerm_resource_group.hub.location
  name                = "pip-fw-mgmt-complex"
  resource_group_name = azurerm_resource_group.hub.name
  sku                 = "Standard"
  tags                = var.tags
  zones               = ["1", "2", "3"]
}

# Azure Firewall with complex configuration
resource "azurerm_firewall" "this" {
  location            = azurerm_resource_group.hub.location
  name                = "fw-complex-test"
  resource_group_name = azurerm_resource_group.hub.name
  sku_name            = "AZFW_VNet"
  sku_tier            = "Standard"
  firewall_policy_id  = azurerm_firewall_policy.this.id
  tags                = var.tags
  zones               = ["1", "2", "3"]

  ip_configuration {
    name                 = "configuration"
    public_ip_address_id = azurerm_public_ip.firewall.id
    subnet_id            = azurerm_subnet.firewall.id
  }
  management_ip_configuration {
    name                 = "mgmt-configuration"
    public_ip_address_id = azurerm_public_ip.firewall_mgmt.id
    subnet_id            = azurerm_subnet.firewall_mgmt.id
  }
}

# Firewall policy with rules
resource "azurerm_firewall_policy" "this" {
  location            = azurerm_resource_group.hub.location
  name                = "fw-policy-complex"
  resource_group_name = azurerm_resource_group.hub.name
  sku                 = "Standard"
  tags                = var.tags

  dns {
    proxy_enabled = true
  }
}

# Application rule collection for Container Apps
resource "azurerm_firewall_policy_rule_collection_group" "this" {
  firewall_policy_id = azurerm_firewall_policy.this.id
  name               = "ContainerAppsRules"
  priority           = 500

  application_rule_collection {
    action   = "Allow"
    name     = "ContainerAppsAllow"
    priority = 500

    rule {
      name              = "AllowContainerRegistry"
      destination_fqdns = ["*.azurecr.io", "*.microsoft.com", "*.azure.com"]
      source_addresses  = ["10.50.0.0/16"] # Spoke network

      protocols {
        port = 443
        type = "Https"
      }
    }
    rule {
      name              = "AllowPackageManagers"
      destination_fqdns = ["*.npmjs.org", "*.nuget.org", "*.pypi.org"]
      source_addresses  = ["10.50.0.0/16"]

      protocols {
        port = 443
        type = "Https"
      }
    }
  }
  network_rule_collection {
    action   = "Allow"
    name     = "ContainerAppsNetwork"
    priority = 400

    rule {
      destination_ports     = ["53"]
      name                  = "AllowDNS"
      protocols             = ["TCP", "UDP"]
      destination_addresses = ["168.63.129.16"] # Azure DNS
      source_addresses      = ["10.50.0.0/16"]
    }
  }
}

# UDR for spoke to route through firewall
resource "azurerm_route_table" "spoke" {
  location            = azurerm_resource_group.hub.location
  name                = "rt-spoke-via-fw"
  resource_group_name = azurerm_resource_group.hub.name
  tags                = var.tags

  route {
    address_prefix         = "0.0.0.0/0"
    name                   = "DefaultRoute"
    next_hop_in_ip_address = azurerm_firewall.this.ip_configuration[0].private_ip_address
    next_hop_type          = "VirtualAppliance"
  }
  route {
    address_prefix = "0.0.0.0/0"
    name           = "InternetRoute"
    next_hop_type  = "Internet"
  }
}

# Most complex scenario: Network appliance with custom naming and all features
module "aca_lza_hosting" {
  source = "../../"

  # Application Gateway with self-signed certificate (COMPLEX)
  deployment_subnet_address_prefix = "10.50.4.0/24"
  # Full observability with custom configuration (COMPLEX)
  enable_application_insights = true
  enable_dapr_instrumentation = true
  # Core - custom named RG (COMPLEX)
  location                                        = var.location
  spoke_application_gateway_subnet_address_prefix = "10.50.3.0/24"
  spoke_infra_subnet_address_prefix               = "10.50.1.0/24"
  spoke_private_endpoints_subnet_address_prefix   = "10.50.2.0/24"
  # Large address space for complex scenarios
  spoke_vnet_address_prefixes      = ["10.50.0.0/16"] # Large spoke
  vm_admin_password                = "NotUsedForSSH123!"
  vm_jumpbox_subnet_address_prefix = "10.50.5.0/24"
  # Linux VM with SSH for testing appliance connectivity (COMPLEX)
  vm_size                     = "Standard_D4s_v3" # Larger VM for testing
  created_resource_group_name = var.custom_resource_group_name
  # All features enabled (COMPLEX)
  deploy_sample_application = true
  # Zone redundancy for production-like setup (COMPLEX)
  deploy_zone_redundant_resources = true
  # DDoS protection for enterprise scenarios (COMPLEX - expensive)
  enable_ddos_protection     = var.enable_ddos_protection
  enable_telemetry           = var.enable_telemetry
  environment                = var.environment
  expose_container_apps_with = "applicationGateway"
  # Complex hub-spoke with network appliance (COMPLEX)
  hub_virtual_network_resource_id = azurerm_virtual_network.hub.id
  network_appliance_ip_address    = azurerm_firewall.this.ip_configuration[0].private_ip_address
  route_spoke_traffic_internally  = false # Force through hub appliance
  # Premium storage for high performance (COMPLEX)
  storage_account_type        = "Premium_LRS"
  tags                        = var.tags
  use_existing_resource_group = false
  vm_authentication_type      = "sshPublicKey"
  vm_jumpbox_os_type          = "linux"
  vm_linux_ssh_authorized_key = tls_private_key.ssh_key.public_key_openssh
  # Custom naming (COMPLEX)
  workload_name = var.workload_name

  depends_on = [
    azurerm_firewall.this,
    azurerm_firewall_policy_rule_collection_group.this
  ]
}

# Associate route table with spoke subnets after module deployment
resource "azurerm_subnet_route_table_association" "spoke_infra" {
  route_table_id = azurerm_route_table.spoke.id
  subnet_id      = "${module.aca_lza_hosting.spoke_virtual_network_id}/subnets/snet-spoke-infrastructure"
}








```

<!-- markdownlint-disable MD033 -->
## Requirements

The following requirements are needed by this module:

- <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) (>= 1.9, < 2.0)

- <a name="requirement_azapi"></a> [azapi](#requirement\_azapi) (~> 2.4)

- <a name="requirement_azurerm"></a> [azurerm](#requirement\_azurerm) (~> 4.0)

- <a name="requirement_tls"></a> [tls](#requirement\_tls) (~> 4.0)

## Resources

The following resources are used by this module:

- [azurerm_firewall.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/firewall) (resource)
- [azurerm_firewall_policy.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/firewall_policy) (resource)
- [azurerm_firewall_policy_rule_collection_group.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/firewall_policy_rule_collection_group) (resource)
- [azurerm_public_ip.firewall](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/public_ip) (resource)
- [azurerm_public_ip.firewall_mgmt](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/public_ip) (resource)
- [azurerm_resource_group.hub](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/resource_group) (resource)
- [azurerm_route_table.spoke](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/route_table) (resource)
- [azurerm_subnet.firewall](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/subnet) (resource)
- [azurerm_subnet.firewall_mgmt](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/subnet) (resource)
- [azurerm_subnet_route_table_association.spoke_infra](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/subnet_route_table_association) (resource)
- [azurerm_virtual_network.hub](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/virtual_network) (resource)
- [tls_private_key.ssh_key](https://registry.terraform.io/providers/hashicorp/tls/latest/docs/resources/private_key) (resource)

<!-- markdownlint-disable MD013 -->
## Required Inputs

No required inputs.

## Optional Inputs

The following input variables are optional (have default values):

### <a name="input_custom_fqdn"></a> [custom\_fqdn](#input\_custom\_fqdn)

Description: Custom FQDN for the Application Gateway.

Type: `string`

Default: `"enterprise-aca.contoso.com"`

### <a name="input_custom_resource_group_name"></a> [custom\_resource\_group\_name](#input\_custom\_resource\_group\_name)

Description: Custom name for the main resource group that the module will create.

Type: `string`

Default: `"rg-aca-lza-enterprise-complex"`

### <a name="input_enable_ddos_protection"></a> [enable\_ddos\_protection](#input\_enable\_ddos\_protection)

Description: Enable DDoS protection. WARNING: This is very expensive and should only be enabled for production or testing purposes.

Type: `bool`

Default: `false`

### <a name="input_enable_telemetry"></a> [enable\_telemetry](#input\_enable\_telemetry)

Description: This variable controls whether or not telemetry is enabled for the module.

Type: `bool`

Default: `true`

### <a name="input_environment"></a> [environment](#input\_environment)

Description: The environment identifier for the module.

Type: `string`

Default: `"prod"`

### <a name="input_location"></a> [location](#input\_location)

Description: The Azure region where the resources will be deployed.

Type: `string`

Default: `"East US"`

### <a name="input_resource_group_name"></a> [resource\_group\_name](#input\_resource\_group\_name)

Description: The base name for resource groups.

Type: `string`

Default: `"rg-aca-lza-complex"`

### <a name="input_tags"></a> [tags](#input\_tags)

Description: Map of tags to assign to the resources.

Type: `map(string)`

Default:

```json
{
  "complexity": "high",
  "environment": "production",
  "purpose": "enterprise-testing",
  "workload": "container-apps"
}
```

### <a name="input_workload_name"></a> [workload\_name](#input\_workload\_name)

Description: The name of the workload.

Type: `string`

Default: `"enterprise"`

## Outputs

The following outputs are exported:

### <a name="output_application_gateway_fqdn"></a> [application\_gateway\_fqdn](#output\_application\_gateway\_fqdn)

Description: Application Gateway FQDN

### <a name="output_container_apps_environment_fqdn"></a> [container\_apps\_environment\_fqdn](#output\_container\_apps\_environment\_fqdn)

Description: Container Apps Environment default domain

### <a name="output_firewall_private_ip"></a> [firewall\_private\_ip](#output\_firewall\_private\_ip)

Description: Azure Firewall private IP address

### <a name="output_firewall_public_ip"></a> [firewall\_public\_ip](#output\_firewall\_public\_ip)

Description: Azure Firewall public IP address

### <a name="output_hub_virtual_network_id"></a> [hub\_virtual\_network\_id](#output\_hub\_virtual\_network\_id)

Description: Hub virtual network ID

### <a name="output_route_table_id"></a> [route\_table\_id](#output\_route\_table\_id)

Description: Route table ID for spoke network

### <a name="output_spoke_virtual_network_id"></a> [spoke\_virtual\_network\_id](#output\_spoke\_virtual\_network\_id)

Description: Spoke virtual network ID

### <a name="output_ssh_private_key"></a> [ssh\_private\_key](#output\_ssh\_private\_key)

Description: SSH private key for Linux VM

## Modules

The following Modules are called:

### <a name="module_aca_lza_hosting"></a> [aca\_lza\_hosting](#module\_aca\_lza\_hosting)

Source: ../../

Version:

## Additional Resources

- [Azure Container Apps Landing Zone Accelerator](https://github.com/Azure/aca-landing-zone-accelerator)
- [Azure Verified Modules Documentation](https://azure.github.io/Azure-Verified-Modules/)
- [Azure Container Apps Documentation](https://docs.microsoft.com/azure/container-apps/)
<!-- END_TF_DOCS -->